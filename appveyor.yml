version: 0.0.1.{build}-test

shallow_clone: true

os:
- Windows Server 2012 R2

environment:
  LuaRocks: 2.3.0
  matrix:
  - Lua: lua 5.3
  - Lua: luajit 2.0

configuration:
  - mingw
  - vs_32
  - vs_64

# this is how to allow failing jobs in the matrix
matrix:
  # LuaJIT crashes on C++ exception on x86
  allow_failures:
    - platform: x86
      Lua: luajit 2.0

cache:
  #- c:\lua -> appveyor.yml
  - c:\external -> appveyor.yml
  - c:\blast -> appveyor.yml

install:
# Setup Lua development/build environment
- PATH %CD%\here\bin;C:\mingw\bin;%PATH%
- curl --location --silent --fail --max-time 120 --connect-timeout 30 https://raw.githubusercontent.com/mpeterv/hererocks/master/hererocks.py > hererocks.py
- python hererocks.py here --%Lua% --luarocks=%LuaRocks% --verbose --target=%Configuration% --no-git-cache
# Downloand and install blast to c:\blast
- call .appveyor\install_blast.bat
- luarocks install "https://gist.githubusercontent.com/starius/719b194bb34ce612458c/raw/7ab5aa457164c5dccef2c06e0e06ffbed09319df/mediator_lua-1.1.1-0.rockspec"
- luarocks install lua-term 0.3-1  # 0.4 is broken on Windows
- luarocks install busted
- luarocks install luacov
- if "%LUA_SHORTV%"=="5.1" luarocks install bit32
- luarocks install luacov-coveralls
- luarocks install lua-llthreads2
- luarocks install tree

build_script:
- luarocks make BOOST_INCDIR=c:\Libraries\boost "CFLAGS=/nologo /MD /O2 /EHa"

test_script:
- cd %APPVEYOR_BUILD_FOLDER%
- busted -c -o .appveyor/busted-print.lua

after_test:
- luacov-coveralls -v
